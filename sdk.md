# 嵌入式SDK类软件的重构设计
在嵌入式软件领域，很多人看到SDK的第一反应是那套基于命令行的配置交互界面，其实不
然。在众多嵌入式软件的分层结构中都能看到SDK的名字，这些名为SDK的模块规模和功能都不相
同，有的是薄薄的一层接口封装；有的却很厚重，包含着复杂的计算逻辑，到底什么样的模
块才需要设计为SDK，SDK又如何能设计的合理，最后才不会沦为找不到更好名字的替代品。
本文将从定义，怀味道发现，推荐设计等一系列的方面试图为嵌入式SDK类软件的设计找到
清晰的方向。

## SDK，API，Framework，Library 傻傻分不清楚
SDK和API有什么关系？它是一种框架吗？它不就是一种Library吗？鉴于尚且有很多人在这
些概念上有模糊，我们先把通过对比把SDK的定位明确，范围的确定不管对写文章还是对写
代码都应该是首要工作不是吗？
* SDK
SDK(Software Development Kit, 软件开发工具包）总体上来讲任何软件都可能
面临着需要来对上层屏蔽下层细节的一层软件封装的模块。在嵌入式领域内应该包含API,
实现库和配套的文档用例等。旨在隔离上下层不同的变化方向。
* API
API(Application Programming Interface, 应用编程接口)，是由功能提供方定义，调用方
使用的一组接口。接口的实现形式可以是函数，Rest接口，文件等多种形式。
* Framework
Framework即我们所说的框架，是提炼于某一领域的功能知识的沉淀，一般包含的范围比较大，包含但不限于功能中间件，开发工
具，编程规范等。总得来说Framework是一种比较强的约束，选择在某一框架下开发意味着
遵循类一套框架作者的设计原则。
* Library
Library即我们所说的库,通常是某些功能的具体实现。一般由一些确定的API和具体实现代
码组成，一般以构建产物（动态链接库或静态链接库）的形式发布。Library是一种软件的
组织复用方式，

可以看出API和Library是相对更通用和基础的概念，SDK和Framework是更综合的概念，而
Framework理论上是应该包含一套SDK的，否则Framework如何使用又提供什么价值呢？但相
对于SDK，Framework包含但范围更大，很可能超出编码层面，例如构建逻辑，打包逻辑等，
而SDK相对提供更原子的功能代码封装。例如 sprint和JDK

## SDK 设计怀味道

### 不知道该如何使用
用过linux的都知道通过help或usage，man手册来如何使用一些小工具，但可能由于没有对
外提供但原因，产品内部的SDK很少提供手册的。是不需要吗？真的是需要形而上学的那个
交付物吗？非也。SDK要有使用说明给用户一个上手指导是一方面的诉求，另一个隐含的重
要原因是要SDK的API设计要站在用户的角度考虑怎么用。很多内部API由于不需要提供说明，
经常是稍作封装就把内部的函数暴露出来，既不从整体上考虑用户拿到这个接口如何使用，
也不考虑这个接口提供后与其他接口的影响，是否会给使用者造成困惑。如果提供的接口有
个好名字，作为用户我们还可以稍微理解下，猜出个七七八八，对于不认真起名的接口，最
终难免落个无人问津的下场。相比无人问津，不可预知的SDK组合使用往往会给用户造成直
接的损失，由于没有手册，也就没有相应的约束，用户可能会以提供者预想不到的方式调用
接口，进而造成莫名其妙的错误。
### 接口职责不单一
是不是经常看到这样的接口，想要完成想要的功能，不得不传入其他很多不需要的参数，很
容易传错造成失败。即便小心翼翼的把各个参数填写正确了，也会导致代码非常难看，不得
不做一层封装适配，避免其他人再阅读到此处代码时，被无关的参数干扰了关键信息的获取。
### 前向兼容差
可能是由于内部SDK并不对外提供的原因，内部团队之间毕竟还属于一个公司，沟通起来也
毕竟便捷，因此在兼容性设计上往往缺乏考虑，经常一个版本的更迭，导致大量的API更换
或废弃，引起上层用户的大面积修改或适配。
### 内部实现缺少领域建模
不像前面几个坏味道都直接对用户造成影响，这个怀味道初期可能不会引起客户的大量吐槽，但
长时间看来对于守护SDK模块的团队影响较大。某个SDK诞生之初往往是比较清晰的逻辑，例如封装某些
器件的变化，这样上层软件就不需要感知到硬件变化的差异，但随着时间的推移，支持的硬
件越来越多，缺乏领域建模的SDK模块出现故障频发，交付周期变长等一系列不适的症状，
最终将陷入`大泥球`窘境。


## SDK设计
从常见的问题我们可以看出主要问题归纳为以下3个方面，我们后续会针对性的从3个方面吗
来考虑如何改善整体SDK的设计。

* 帮助文档设计
* API设计
* SDK建模

### 测试用例作为帮助文档
为什么说最好的文档的就是测试用例？这样的实践在开源项目已经广泛的使用 
对于SDK的测试用例，并非全部都要端到端的测试，尤其是当API参数组合非常多的时候，一
方面表明变量多，交叉组合复杂，也说明这个API的逻辑是比较复杂的，这种情况推荐使用
部分UT来结偶这部分的复杂度。
还有一个容易被忽视的，就是配置的变化，比如SDK在选用不同芯片时，将上层API转换成调
用的底层接口肯定是有差异的，按照怎样的方式组合不同变化方向的用例就成为另一门学问。

### API设计
作为SDK类软件，提供给上层的软件支持，接口API的设计尤为重要，通过前文的怀味道我们
也可以推敲出优秀的API设计应该包含以下的特征：
* 提供功能正交的接口API，用户不会困惑多个API可以达到相同的功能
* 版本管理和向前兼容，何时废弃之前的API，新增的API需要做哪些兼容性的设计，避免
  API爆炸式的增长。
* 合理设计的参数和使用方法。

#### 单一职责
`单一职责`这个词几乎贯穿与软件设计的方方面面，不论是编码，设计，架构层面无一不发
挥重要作用。API设计本质还是软件设计的范畴，因此也绕不过这个基本原则。理论上任何
一个函数，类设计接口时，都应该遵循单一职责，但由于不同类和函数的用户多少有差异，
对设计的要求不同，如果接口是内部类，往往会比较宽松，API就属于强制对外的接口，并
且在很长一段时间内，都需要前向兼容支持，因此设计得职责不单一对后期的维护是极大的
负担。
单一职责的设计表现在多个方面，一个是命名，一个是参数。
* 含糊的命名
  往往导致这个API的职责范围不明确，比如`access`这一命名的一个接口，定义
了，任何访问接口都使用这个统一都入口，再通过参数的变化，来区分不同的功能，这样的
接口看似稳定，但无形之中把多个功能耦合在一个接口里，稍有设计的程序员把这个接口的
参数设计得极为灵活，避免频繁修改，但不得不为这个过于通用的API增加一层解释分发的
处理；资历尚浅的程序员，不得不反复的修改接口的参数来应对新增API的需求。

* 过多的参数
  严谨的讲，参数的多少并不足以判定一个函数的职责。但大多数情况如此。更合理但判定
  方法应该是是否每个参数都同时变化，或者变化频度相当，如果有一个参数是为了区分功
  能，其他参数是为了在不同功能下的具体使用，那奉劝各位还是提供多个API
  
#### 兼容性设计
兼容设计的最大误区：设计一个通用的API，所有用户都使用这一个API，参数极度灵活。这
其实是一种懒政的表现。


#### 同步与异步
纵观所有的API设计，本着能不异步绝不异步的准则，异步会带来非常大的操作风险。异步
的API设计，需要维护异步启动的上下文，并要求客户管理上下文的生命周期，由于对调用
方的不可控，很难像gc一样自动管理。异步的API还需要谨慎的管理关联API的调用次序，给
出合适的异常反馈。但万事无绝对，也并非要求必须异步的场景，也必须同步化，引入额外
的复杂度和成本开销，比如linux文件操作的接口。必须先创建或打开，然后由客户操作后，
关闭。


### SDK建模
文档设计和API设计解决了外部矛盾，SDK建模就是要解决内部矛盾的钥匙。

我们尝试把见到过的SDK类模块软件分为两种：
* 扁平化SDK，这类SDK的特点是支持的API种类繁多，但各自之间关联性不大，这种一般不
  存储数据，例如功能配置类的SDK，算法类SDK等。
* 纵深类SDK，这类SDK的特点是接口比较简单，但内部管理状态或数据，例如故障检测类的SDK

不管是哪种SDK，封装的领域如何千差万别，但由于SDK类软件的特点，一般都有以下两个主要变化方向：
* 上层API的变化，
* 底层实现的变化

对于扁平化都ADK，底层实现上的变化会少一点，而对纵深类的SDK，上层API的变化则不那
么频繁发生。

通常软件工程师都会按照变化方向来进行分层隔离，我们看到的大多数SDK类软件也是这么
分层的，但经常出现两级分化的情况，要么API层最后变得很厚重，要么实现层变得非常庞
大。这其实是在释放一种信号，有一部分代码逻辑无处安放，可能缺少了一个层次。

#### API层

API层的变化取决于客户的诉求，API层的新增需求可能只需要重新组合现有的领域层接口就
能支持，向前兼容适配的工作需要消除在这层，这层相当于防腐层的作用，屏蔽掉外部诉求
对内部的影响。这部分应该是比较薄的，且逻辑相对简单。


#### 领域层
如所有软件建模一样，核心领域层的模型是消除知识重复的根本，领域模型层应该是整个软
件的核心，代表业务价值，相对稳定。良好设计的领域层，应该是稳定的，领域对象直接的
逻辑关系是清晰的，对上层提供的接口是稳定且符合领域对象本身的业务属性的。这部分当
且仅当领域概念扩充或变更时才进行修改和调整，因此相对稳定。
原则的问题往往是很容易说，但很难做到的。


#### 配置层
也可以叫服务层或编排层，以领域模型层的作为基础，通过灵活的组合方式，为提供给API层组合和
使用，简单的服务层可以是一些配置文件，复杂的配置层可能需要定义DSL来支持。这层虽
然不如领域层核心，但在整个SDK软件中扮演桥梁的作用，配置解析或DSL解析，原语定义等
属于这层的核心资产。

### 总结
本文通过咨询中的见闻和思考，针对嵌入式环境下SDK类软件常见的一些误区，探索更为合
理的SDK软件设计方法，虽然软件要解决的问题领域多有差异，但依据SDK类软件的一般特征
推到的三层架构模式，对同类型软件具有相当的推广意义。希望可以为仍在苦海中摸爬滚打的同行，一些思考和借鉴。

