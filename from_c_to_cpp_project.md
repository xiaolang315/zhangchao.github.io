# 从C到C++工程演进

## 背景
C++诞生之初就背负了改进C语言的使命，也一致秉承着良好兼容性，提供了更多的技术手段
来改进C语言中的不足，长久依赖在学院中被当作C语言进阶的学科来进行教授。在通信，汽
车等嵌入式领域，曾几何时都是C语言的天下，C++则更多的出现在图形图像处理，GUI，服
务器等需要相对高级语言特性的领域。但随着其他新兴语言但诞生，C++的领地逐渐被蚕食，
而随着嵌入式软件领域规模扩大，原本嵌入式领域的C语言从业人员很多来自于主业的转行，
（例如通信专业，电子专业等）工程和设计能力的缺失导致无法驾驭数以千万级的代码。无
处安身的C++语言仿佛救命稻草一般，被当作转型的良药，转型一时风光无限，过后无数填
坑的项目数不胜数。看到此处，不少人肯定认为本文是要开始黑C++了，不然，笔者作为多
年C++程序员，对这门功能强大的语言还是推崇的，本文希望可以从一个客观的角度，给想
把项目从C切换C++语言的决策者一些分析和建议。

## 获得优势

### 更少的代码
借助模版类型推导技术和更丰富的标准库，C++可以用跟少的代码完成C相同的功能，
### 更符合领域模型的代码
由于C++语言多范式的设计哲学，以及C++11以后引入的函数式编程能力，让C++在应对各种
类型的领域模型时，都能更游刃有余的写出匹配的代码。

## 承担风险

### 性能损失
在很多关于语言性能的网站上，都可以看到C和C++几乎是长时间霸占第一梯队的，往往这些
网站对比的都是运行时效率和内存占用，对于嵌入式工程来说还有一个标准库的问题，C/C++
标准库是通过静态库和动态库的两部分提供的。对于一个纯C的项目，它要切换成C++需要在
设备上新增libc++这个动态运行库，根据gcc-C++14的lib，在strip后还需要3+M的大小，这
点内存放在时下的服务器上，当然微乎其微了，但对于某些嵌入式小设备，可能是个不容忽
视的成本增加。

其实在工程效率的领域，编译时间是个不可忽视的属性。通过精心的设计，固然可以在运行
性能上做到相差无几，由于需要支持更复杂的语法和特性，包括类型推演和模板代码生成，
编译时间上有时是数量级的提升，在规模庞大的项目中显得尤为突出。
### 学习成本
C语言有32个关键字，C++到11已经有73个关键字，加上模版的机制，以及标准库的使用方法
学习，相对于C来说确实有比较高的学习曲线。更多的特性也带来了更多的使用风险，导致
每一代标准的诞生都会伴随着一套effective来查缺补漏，看看C++Prime的厚度，怕是已经
让很多程序员望而却步了。

## 切或不切

### 设计演进
语言从来都不是一个项目或软件的决定因素，诚然我们不能泯灭工具的便利为效率提升带来
的好处，但它不是万恶之源，不是影响整个软件交付的罪魁祸首，缺乏设计是。如果当前的
项目软件设计本就比较合理，代码的划分又与领域对象非常契合，那为何要承担语言切换的
种种成本呢？但大多数情况往往是在C语言项目规模庞大到一定程度，发现需求很难加，故
障又很难受收敛，这些现象通常预示设计上已经出现腐化，需要重构，使用C语言也并非不
可以做面向对象的设计。

### 规模
切或不切，是要看成本的，规模的大小直接决定切的成本。规模方面我们从2个角度来看
#### 软件规模
当软件规模相对比较小（姑且拍脑袋万行以下），切或不切真的不是太大的问题，规模越小
需要付出的开发成本和测试成本就越低，需要撬动重新学习的开发人员就越少。千万别忽视
了这方面的阻力成本，众口铄金，当大部分的开发人员抱怨学习成本时，极有可能导致转型
的结果不敬如人意，甚至夭折。

#### 用户规模
用户规模往往是个大家容易忽视的地方，即便软件规模很小，但用户规模非常大，那么就需
要额外考虑在切换时，用户使用方式上的变化，终端使用的用户是否能接受内存增大？调用
类的API用户是否能接受接口的变更而引起的代码改动？

### 兼容性设计
套用一句网络用语，“小孩子才做选择题，大人从来都是都要”。从C++诞生到第一天起，与C
良好到兼容性始终都是它的重大卖点之一。当C工程中想要使用C++特性时，完全可以做到部
分替换为C++，只要保持C接口特征即可。
